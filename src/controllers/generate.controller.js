import axios from "axios";
import cloudinary from "../config/cloudinary.js";
import { generateWithGemini } from "../services/services.js";

export const generateImage = async (req, res) => {
  try {
    const { prompt } = req.body;

    //  VALIDATION
    if (!prompt) {
      return res.status(400).json({ error: "Prompt required" });
    }

    const peopleFiles = req.files?.peopleFiles || [];
    const roomFiles = req.files?.roomFiles || [];

    if (!peopleFiles.length || !roomFiles.length) {
      return res.status(400).json({
        error: "People images and room image required"
      });
    }


    //  CONVERT CLOUDINARY URL â†’ BASE64 FOR GEMINI
    
    const allFiles = [...peopleFiles, ...roomFiles];

    const images = await Promise.all(
      allFiles.map(async (file) => {
        const response = await axios.get(file.path, {
          responseType: "arraybuffer"
        });

        return {
          mimeType: file.mimetype,
          base64: Buffer.from(response.data).toString("base64")
        };
      })
    );

 
    //GEMINI IMAGE GENERATION
   

    const aiResponse = await generateWithGemini({ prompt, images });

    const candidate = aiResponse?.candidates?.[0];
    const imagePart = candidate?.content?.parts?.find(
      p => p.inlineData?.data
    );

    if (!imagePart) {
      console.error("FULL AI RESPONSE:", JSON.stringify(aiResponse, null, 2));
      return res.status(500).json({
        error: "Image was not generated by Gemini"
      });
    }

  
    // UPLOAD GENERATED IMAGE TO CLOUDINARY
  

    const uploadResult = await cloudinary.uploader.upload(
      `data:${imagePart.inlineData.mimeType};base64,${imagePart.inlineData.data}`,
      {
        folder: "ai-generator/generated"
      }
    );

    
    // RESPONSE
    

    res.json({
      success: true,
      imageUrl: uploadResult.secure_url
    });

  } catch (error) {
    console.error("CONTROLLER ERROR:", error);
    res.status(500).json({ error: error.message });
  }
};
